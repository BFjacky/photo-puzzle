(window.webpackJsonp=window.webpackJsonp||[]).push([[0],[function(t,e){t.exports="// 定义一个属性 apos\nattribute vec3 apos;\nattribute vec4 a_color;\n// 纹理\nattribute vec2 aTextureCoord;//纹理坐标\nattribute float aTextureId;//纹理id\nattribute vec4 a_color_delta;// 顶点颜色偏移\n\nvarying vec4 vColorDelta;\nvarying vec4 v_color;\nvarying float vTextureId;\nvarying highp vec2 vTextureCoord;//插值后纹理坐标\nvarying vec4 debug_color;\n\n// 矩阵\nuniform mat4 modelMatrix3D;// 三维模型矩阵\nuniform mat4 projectMatrix3D;// 三维视图矩阵\n\nvoid main(){\n    //顶点位置，位于坐标原点\n    vec4 temp =modelMatrix3D * vec4(apos.x,apos.y,apos.z,1.);// vec4(apos.x / 500., apos.y / 500., 1.0 , 1.0);\n    //给内置变量gl_PointSize赋值像素大小\n    gl_Position = vec4(temp.xyz,1.);\n    gl_PointSize=20.;\n    // 纹理坐标\n    vTextureCoord=aTextureCoord;\n    // 顶点颜色\n    v_color=vec4(a_color.r/255.,a_color.g/255.,a_color.b/255.,a_color.a/255.);\n    vTextureId=aTextureId;\n    vColorDelta=vec4(a_color_delta.r/255.,a_color_delta.g/255.,a_color_delta.b/255.,a_color_delta.a/255.);\n}"},function(t,e){t.exports="precision highp float;\nvarying vec4 v_color;\nvarying highp vec2 vTextureCoord;\nvarying vec4 color_apos;\nvarying float vTextureId;\nvarying vec4 vColorDelta;\nuniform sampler2D uSamplers[<<<uSamplerLength>>>];\n// debug color\nvarying vec4 debug_color;\n\nvoid main(){\n    vec4 textureColor;\n    <<<gl_FragColor>>>\n    gl_FragColor = textureColor+vColorDelta;\n}"},function(t,e,i){"use strict";i.r(e);var r=i(0),s=i.n(r),o=i(1),n=i.n(o);class a{constructor(t,e,i,r){this._verArrayBuffer=t,this._indexArrayBuffer=i,this.strideBytes=36,this.indexesLength=r,this._verticleAttributes=e}bind(t,e){const i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,this._verArrayBuffer,t.STATIC_DRAW);const r=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,r),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this._indexArrayBuffer,t.STATIC_DRAW);const s={4:t.FLOAT,2:t.SHORT,1:t.UNSIGNED_BYTE},o=this._verticleAttributes.reduce((t,e)=>t+e.countPerVerticle*e.bytePerValue,0);let n=0;for(const i of this._verticleAttributes){const r=t.getAttribLocation(e,i.attribute);t.enableVertexAttribArray(r),t.vertexAttribPointer(r,i.countPerVerticle,s[i.bytePerValue],!1,o,n),n+=i.countPerVerticle*i.bytePerValue}}static calculateArrayBufferByteLength(t){let e=0;if(t[0])for(const i in t[0])"baseIndexes"!==i&&"indexes"!==i&&(e+=t[0][i].bytePerValue*t[0][i].countPerVerticle);return{verticleAttributeABByteLength:e*t.length*3,verticleIndexABByteLength:3*t.length*4}}static createArrayBuffer(t,e){const i=new ArrayBuffer(t),r={4:new Float32Array(i),2:new Int16Array(i),1:new Uint8Array(i)},s=new ArrayBuffer(e);return{verArrayBuffer:i,arrayBufferViewMap:r,indexArrayBuffer:s,indexUint32View:new Uint32Array(s)}}static extractVerticleAtributes(t){const e=[];if(t[0])for(const i in t[0])"baseIndexes"!==i&&"indexes"!==i&&e.push({key:i,attribute:t[0][i].attribute,bytePerValue:t[0][i].bytePerValue,countPerVerticle:t[0][i].countPerVerticle});return e}static from(t){const e=a.extractVerticleAtributes(t),{verticleAttributeABByteLength:i,verticleIndexABByteLength:r}=a.calculateArrayBufferByteLength(t),{verArrayBuffer:s,arrayBufferViewMap:o,indexArrayBuffer:n,indexUint32View:h}=a.createArrayBuffer(i,r);let l=0,c=0;for(let i=0;i<t.length;i++){for(let r=0;r<3;r++)for(const s of e){const{key:e,bytePerValue:n,countPerVerticle:a}=s;for(let s=0;s<a;s++)o[n][l/n]=t[i][e].data[r*a+s],l+=n}for(let e=0;e<t[i].indexes.length;e++)h[c/4]=t[i].indexes[e],c+=4}return new a(s,e,n,h.length)}}var h=a;var l=class{constructor(){this.records={}}start(t,e){if(this.records[t])return this.records[t].start=(new Date).getTime(),this.records[t].extraText=e.extraText,void this.records[t].times++;this.records[t]={start:(new Date).getTime(),interval:e.interval,extraText:e.extraText},this.records[t].times=this.records[t].times||0,this.records[t].times++}end(t){if(this.records[t]){if(this.records[t].interval&&this.records[t].times%this.records[t].interval!=0)return;console.log(`${t}:${(new Date).getTime()-this.records[t].start},${this.records[t].extraText}`),delete this.records[t]}}};var c=class{constructor(t){this._gl=t,this._activeTextures=[]}static MAX_TEXTURE_LIMITS(t){return t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS)}setShader(t){this._shaderProgram=t}_setSamplerUniform(t){for(let e=0;e<t;e++)this._gl.uniform1i(this._gl.getUniformLocation(this._shaderProgram,`uSamplers[${e}]`),e)}bindTextures(t){this._setSamplerUniform(t.length);const e=[],i=t.filter(t=>(t.isBind&&e.push(t.bindedTextureUnitOrder),!t.isBind));this._activeTextures.filter(e=>!t.includes(e)).forEach(t=>{t.unbind()});let r=0;i.forEach(t=>{if(!t.loaded)return;for(;e.includes(r);)r++;const i=this._gl["TEXTURE"+r];t.bind(i,r),e.push(r)}),this._activeTextures=t}};const u=document.createElement("canvas"),d=u.getContext("2d");class g{static from(t){return new g(t)}static getImageHtmlEle(t){return new Promise(e=>{const i=new Image;i.onload=function(){e(i)},i.src=t})}constructor(t,e=1){this.imageSrc=t,this.bindedTextureUnitOrder=null,this.isBind=!1,this.webglTexture=null,this.onloadCallback=[],this.loaded=!1,g.getImageHtmlEle(this.imageSrc).then(t=>{this.width=Math.floor(t.width*e),this.height=Math.floor(t.height*e),this.loaded=!0,this.imageHtmlEle=t,u.width=this.width,u.height=this.height,d.clearRect(0,0,u.width,u.height),d.drawImage(t,0,0,t.width,t.height,0,0,this.width,this.height);const i=d.getImageData(0,0,this.width,this.height);this.imageData=new Uint8Array(i.data),this.loaded=!0,this.onloadCallback.forEach(t=>{t()})})}setWebglContext(t){this._gl=t}bind(t,e){this.imageData&&(this.bindedTextureUnitOrder=e,this.bindingTextureId=t,this._gl.activeTexture(t),this.webglTexture=this._gl.createTexture(),this._gl.bindTexture(this._gl.TEXTURE_2D,this.webglTexture),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this.width,this.height,0,this._gl.RGBA,this._gl.UNSIGNED_BYTE,this.imageData),this._setTexParameteri(),this.isBind=!0)}unbind(){this.isBind=!1,this.bindedTextureUnitOrder=null,this._gl.deleteTexture(this.webglTexture)}_setTexParameteri(){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR)}onload(t){this.onloadCallback.push(t),this.loaded&&t()}}var _=g;var p=class{static createProgram(t,e,i){const r=t.createShader(t.VERTEX_SHADER),s=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(r,e),t.shaderSource(s,i),t.compileShader(r),t.compileShader(s);const o=t.createProgram();return t.attachShader(o,r),t.attachShader(o,s),t.linkProgram(o),t.useProgram(o),t.enable(t.DEPTH_TEST),o}static replaceShaderTextureString(t,e){let i="if(vTextureId < 1.){\n      textureColor = texture2D(uSamplers[0], vTextureCoord);\n            }";for(let t=1;t<e;t++)i+=`else if(vTextureId < ${t+1}.){\n        textureColor = texture2D(uSamplers[${t}], vTextureCoord);\n        }`;return t.replace("<<<gl_FragColor>>>",i).replace("<<<uSamplerLength>>>",e)}};var x=class{constructor(t){this._points=t,this.texture=null,this._webglData=null}get webglData(){return this.calculateWebglData()}calculateWebglData(){const t=[this._points[0].x,this._points[0].y,this._points[0].z,this._points[1].x,this._points[1].y,this._points[1].z,this._points[2].x,this._points[2].y,this._points[2].z],e=[...this._points[0].color,...this._points[1].color,...this._points[2].color],i=[...this._points[0].textureCoord,...this._points[1].textureCoord,...this._points[2].textureCoord];return this._webglData={verticles:{data:t,attribute:"apos",countPerVerticle:3,bytePerValue:4},textureCoord:{data:i,attribute:"aTextureCoord",countPerVerticle:2,bytePerValue:4},baseIndexes:[0,1,2],colors:{data:e,attribute:"a_color",countPerVerticle:4,bytePerValue:1},textureId:{data:[this._points[0].texture.bindedTextureUnitOrder,this._points[1].texture.bindedTextureUnitOrder,this._points[2].texture.bindedTextureUnitOrder],attribute:"aTextureId",countPerVerticle:1,bytePerValue:4},colorsDelta:{data:[...this._points[0].colorsDelta,...this._points[1].colorsDelta,...this._points[2].colorsDelta],attribute:"a_color_delta",countPerVerticle:4,bytePerValue:2}},this._webglData}bindTexture(t){this.texture=t}};var f=class{constructor({position:t,size:e,rotation:i,texture:r}){this.position=t,this.size=e,this.rotation=i,this.texture=r,this.colorsDelta=[0,0,0,0],this._webglData=null,this._triangles=[],this._points=[{},{},{},{}]}get webglData(){return this._webglData||(this._webglData=this.calculateWebglData()),this._webglData}updateProperties({rotation:t,size:e,position:i,colorsDelta:r,texture:s}){void 0!==t&&(this.rotation=t,this._webglData=null),void 0!==e&&(this.size=e,this._webglData=null),void 0!==i&&(this.position=i,this._webglData=null),void 0!==r&&(this.colorsDelta=r,this._webglData=null),void 0!==s&&(this.texture=s,this._webglData=null)}calculateWebglData(){this._points[0]={x:-1,y:1,z:this.position.z},this._points[1]={x:-1,y:-1,z:this.position.z},this._points[2]={x:1,y:-1,z:this.position.z},this._points[3]={x:1,y:1,z:this.position.z};const t=this._renderer.matrixSystem.update2DSpriteModelMatrix({size:this.size,rotation:this.rotation,position:this.position,localSize:{width:2,height:2}});return this._points.forEach(e=>{const i=this._renderer.matrixSystem.transform2DSpritePoints({spriteModelMatrix:t,point:e});e.x=i.x,e.y=i.y}),this._points[0].color=[255,255,255,255],this._points[1].color=[255,255,255,255],this._points[2].color=[255,255,255,255],this._points[3].color=[255,255,255,255],this._points[0].colorsDelta=this.colorsDelta,this._points[1].colorsDelta=this.colorsDelta,this._points[2].colorsDelta=this.colorsDelta,this._points[3].colorsDelta=this.colorsDelta,this._points[0].texture=this.texture,this._points[1].texture=this.texture,this._points[2].texture=this.texture,this._points[3].texture=this.texture,this._points[0].textureCoord=[0,0],this._points[1].textureCoord=[0,1],this._points[2].textureCoord=[1,1],this._points[3].textureCoord=[1,0],this._triangles=[new x(this._points.slice(0,3)),new x([this._points[0],this._points[2],this._points[3]])],this._triangles.map(t=>t.webglData)}setRenderer(t){this._renderer=t}};var m=class{constructor({position:t,size:e,rotation:i}){this._triangles=[],this.position=t,this.size=e,this.colorsDelta=[0,0,0,0],this.textures=null,this.rotation=i,this.next=null,this.prev=null,this._webglData=null,this._points=[{},{},{},{},{},{},{},{}]}get webglData(){return this._webglData||(this._webglData=this.calculateWebglData()),this._webglData}updateProperties({rotation:t,size:e,position:i,colorsDelta:r,textures:s}){void 0!==t&&(this.rotation=t,this._webglData=null),void 0!==e&&(this.size=e,this._webglData=null),void 0!==i&&(this.position=i,this._webglData=null),void 0!==r&&(this.colorsDelta=r,this._webglData=null),void 0!==s&&(this.textures=s,this._webglData=null)}calculateWebglData(){const t={x:-1,y:1,z:-1},e={x:-1,y:-1,z:-1},i={x:-1,y:1,z:1},r={x:-1,y:-1,z:1},s={x:1,y:1,z:-1},o={x:1,y:-1,z:-1},n={x:1,y:1,z:1},a={x:1,y:-1,z:1};this._points=[{...t},{...i},{...r},{...e},{...s},{...n},{...a},{...o},{...t},{...s},{...n},{...i},{...e},{...o},{...a},{...r},{...t},{...s},{...o},{...e},{...i},{...n},{...a},{...r}],this._points.forEach((t,e)=>{t.textureCoord=e%4==0?[0,0]:e%4==1?[0,1]:e%4==2?[1,1]:[1,0],this.textures&&(t.texture=this.textures[Math.floor(e/4)])});const h=this._renderer.matrixSystem.update3DSpriteModelMatrix({size:this.size,rotation:this.rotation,position:this.position,localSize:{width:2,height:2,depth:2}});return this._points.forEach(t=>{const e=this._renderer.matrixSystem.transform3DSpritePoints({spriteModelMatrix:h,point:t});t.x=e.x,t.y=e.y,t.z=e.z}),this._points.forEach(t=>{t.color=[255,255,255,255],t.colorsDelta=this.colorsDelta}),this._triangles=[new x([this._points[0],this._points[1],this._points[2]]),new x([this._points[0],this._points[2],this._points[3]]),new x([this._points[4],this._points[5],this._points[6]]),new x([this._points[4],this._points[6],this._points[7]]),new x([this._points[8],this._points[9],this._points[10]]),new x([this._points[8],this._points[10],this._points[11]]),new x([this._points[12],this._points[13],this._points[14]]),new x([this._points[12],this._points[14],this._points[15]]),new x([this._points[16],this._points[17],this._points[18]]),new x([this._points[16],this._points[18],this._points[19]]),new x([this._points[20],this._points[21],this._points[22]]),new x([this._points[20],this._points[22],this._points[23]])],this._triangles.map(t=>t.webglData)}setRenderer(t){this._renderer=t}};const w=1e-6;let b="undefined"!=typeof Float32Array?Float32Array:Array;Math.random;Math.PI;function v(){let t=new b(9);return b!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function S(t,e,i){let r=e[0],s=e[1],o=e[2],n=e[3],a=e[4],h=e[5],l=e[6],c=e[7],u=e[8],d=i[0],g=i[1],_=i[2],p=i[3],x=i[4],f=i[5],m=i[6],w=i[7],b=i[8];return t[0]=d*r+g*n+_*l,t[1]=d*s+g*a+_*c,t[2]=d*o+g*h+_*u,t[3]=p*r+x*n+f*l,t[4]=p*s+x*a+f*c,t[5]=p*o+x*h+f*u,t[6]=m*r+w*n+b*l,t[7]=m*s+w*a+b*c,t[8]=m*o+w*h+b*u,t}function y(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t}function M(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});function D(){let t=new b(2);return b!=Float32Array&&(t[0]=0,t[1]=0),t}!function(){let t=D()}();function T(){let t=new b(16);return b!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function E(t,e,i){let r=e[0],s=e[1],o=e[2],n=e[3],a=e[4],h=e[5],l=e[6],c=e[7],u=e[8],d=e[9],g=e[10],_=e[11],p=e[12],x=e[13],f=e[14],m=e[15],w=i[0],b=i[1],v=i[2],S=i[3];return t[0]=w*r+b*a+v*u+S*p,t[1]=w*s+b*h+v*d+S*x,t[2]=w*o+b*l+v*g+S*f,t[3]=w*n+b*c+v*_+S*m,w=i[4],b=i[5],v=i[6],S=i[7],t[4]=w*r+b*a+v*u+S*p,t[5]=w*s+b*h+v*d+S*x,t[6]=w*o+b*l+v*g+S*f,t[7]=w*n+b*c+v*_+S*m,w=i[8],b=i[9],v=i[10],S=i[11],t[8]=w*r+b*a+v*u+S*p,t[9]=w*s+b*h+v*d+S*x,t[10]=w*o+b*l+v*g+S*f,t[11]=w*n+b*c+v*_+S*m,w=i[12],b=i[13],v=i[14],S=i[15],t[12]=w*r+b*a+v*u+S*p,t[13]=w*s+b*h+v*d+S*x,t[14]=w*o+b*l+v*g+S*f,t[15]=w*n+b*c+v*_+S*m,t}function P(t,e,i,r,s){const o=1/Math.tan(e/2);if(t[0]=o/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=s&&s!==1/0){const e=1/(r-s);t[10]=(s+r)*e,t[14]=2*s*r*e}else t[10]=-1,t[14]=-2*r;return t}function A(t,e,i,r,s,o,n){const a=1/(e-i),h=1/(r-s),l=1/(o-n);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*-l,t[11]=0,t[12]=(e+i)*a,t[13]=(s+r)*h,t[14]=(n+o)*l,t[15]=1,t}function z(){let t=new b(3);return b!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function R(t,e,i){let r=new b(3);return r[0]=t,r[1]=e,r[2]=i,r}!function(){let t=z()}();class I{constructor(t,e,i){this.stageWidth=t,this.stageHeight=e,this.stageDepth=i,this.modelMatrix=null,this.camera={eye:R(0,0,0),center:R(0,0,-1),up:R(0,1,0)},this.perspective={near:1,fovy:.5*Math.PI},this.update2DStageModelMatrix()}static degreeToRad(t){return t/180*Math.PI}update2DStageModelMatrix(){const t=M(v(),[2/this.stageWidth,2/this.stageHeight]),e=y(v(),[-this.stageWidth/2,-this.stageHeight/2]);return this.modelMatrix=S(v(),t,e),this.modelMatrix}update2DSpriteModelMatrix({size:t,rotation:e,position:i,localSize:r}){const s=t.width/r.width,o=t.height/r.height,n=M(v(),[s,o]),a=y(v(),[i.x/s,i.y/o]),h=function(t,e){let i=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=i,t[2]=0,t[3]=-i,t[4]=r,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}(v(),I.degreeToRad(e)),l=S(v(),a,h);return this.spriteModelMatrix=S(v(),n,l),this.spriteModelMatrix}transform2DSpritePoints({point:t,spriteModelMatrix:e}){const i=function(t,e){let i=new b(2);return i[0]=t,i[1]=e,i}(t.x,t.y),r=(s=D(),n=e,a=(o=i)[0],h=o[1],s[0]=n[0]*a+n[3]*h+n[6],s[1]=n[1]*a+n[4]*h+n[7],s);var s,o,n,a,h;return{x:r[0],y:r[1]}}update3DStageModelMatrix(){const t=A(T(),0,this.stageWidth,0,this.stageHeight,this.stageDepth,0),e=T();e[10]=.5,e[14]=-(.5+this.perspective.near);const i=this.stageWidth/this.stageHeight,r=this.perspective.near,s=this.perspective.fovy,o=P(T(),s,i,r),n=E(T(),o,E(T(),e,t)),a=function(t,e,i,r){let s,o,n,a,h,l,c,u,d,g,_=e[0],p=e[1],x=e[2],f=r[0],m=r[1],b=r[2],v=i[0],S=i[1],y=i[2];return Math.abs(_-v)<w&&Math.abs(p-S)<w&&Math.abs(x-y)<w?function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(t):(c=_-v,u=p-S,d=x-y,g=1/Math.hypot(c,u,d),c*=g,u*=g,d*=g,s=m*d-b*u,o=b*c-f*d,n=f*u-m*c,g=Math.hypot(s,o,n),g?(g=1/g,s*=g,o*=g,n*=g):(s=0,o=0,n=0),a=u*n-d*o,h=d*s-c*n,l=c*o-u*s,g=Math.hypot(a,h,l),g?(g=1/g,a*=g,h*=g,l*=g):(a=0,h=0,l=0),t[0]=s,t[1]=a,t[2]=c,t[3]=0,t[4]=o,t[5]=h,t[6]=u,t[7]=0,t[8]=n,t[9]=l,t[10]=d,t[11]=0,t[12]=-(s*_+o*p+n*x),t[13]=-(a*_+h*p+l*x),t[14]=-(c*_+u*p+d*x),t[15]=1,t)}(T(),this.camera.eye,this.camera.center,this.camera.up);E(T(),a,n);return t}update3DSpriteModelMatrix({size:t,rotation:e,position:i,localSize:r}){const s=T(),o=T(),n=T();!function(t,e){let i=Math.sin(e),r=Math.cos(e);t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=r,t[6]=i,t[7]=0,t[8]=0,t[9]=-i,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(s,I.degreeToRad(e.fromX)),function(t,e){let i=Math.sin(e),r=Math.cos(e);t[0]=r,t[1]=0,t[2]=-i,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=i,t[9]=0,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(o,I.degreeToRad(e.fromY)),function(t,e){let i=Math.sin(e),r=Math.cos(e);t[0]=r,t[1]=i,t[2]=0,t[3]=0,t[4]=-i,t[5]=r,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(n,I.degreeToRad(e.fromZ));const a=E(T(),E(T(),s,o),n),h=t.width/r.width,l=t.height/r.height,c=t.depth/r.depth,u=(d=T(),g=[h,l,c],d[0]=g[0],d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[5]=g[1],d[6]=0,d[7]=0,d[8]=0,d[9]=0,d[10]=g[2],d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,d);var d,g;const _=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}(T(),[i.x/h,i.y/l,i.z/c]),p=E(T(),u,_);return E(T(),p,a)}transform3DSpritePoints({point:t,spriteModelMatrix:e}){const i=R(t.x,t.y,t.z),r=function(t,e,i){let r=e[0],s=e[1],o=e[2],n=i[3]*r+i[7]*s+i[11]*o+i[15];return n=n||1,t[0]=(i[0]*r+i[4]*s+i[8]*o+i[12])/n,t[1]=(i[1]*r+i[5]*s+i[9]*o+i[13])/n,t[2]=(i[2]*r+i[6]*s+i[10]*o+i[14])/n,t}(z(),i,e);return{x:r[0],y:r[1],z:r[2]}}updateStageSize(t){this.stageWidth=t.width,this.stageHeight=t.height,this.stageDepth=t.depth}updateStageModelMatrix(){return this._stageModelMatrix2D=this.update2DStageModelMatrix(),this._stageModelMatrix3D=this.update3DStageModelMatrix(),{stageModelMatrix2D:this._stageModelMatrix2D,stageModelMatrix3D:this._stageModelMatrix3D}}}var B=I;var U=class{constructor(t){this._gl=t}setShader(t){this._shaderProgram=t}bind({uniformName:t,value:e}){const i=this._gl.getUniformLocation(this._shaderProgram,t);this._gl[{4:"uniformMatrix2fv",9:"uniformMatrix3fv",16:"uniformMatrix4fv"}[e.length]](i,!1,e)}};function C(t,e){const i=t.imageData,{rowStart:r,rowEnd:s,colStart:o,colEnd:n}=e,a=[0,0,0,0];let h=0;for(let e=r;e<s;e++)for(let r=o;r<n;r++){if(e>t.height||r>t.width)continue;const s=4*(e*t.width+r);a[0]+=i[s],a[1]+=i[s+1],a[2]+=i[s+2],a[3]+=i[s+3],h++}return a.map(t=>Math.floor(t/h))}function L(t,e,i){const r=[],s=function(t,e,i){const r=Math.floor(t.width/e),s=Math.floor(t.height/i),o=[];for(;o.length<e*i;){const n=Math.floor(Math.floor(o.length/e)/i*t.height),a=n+s,h=Math.floor(o.length%e/e*t.width),l=h+r;o.push({rowStart:n,rowEnd:a,colStart:h,colEnd:l})}return o}(t,e,i);for(const e of s)r.push(C(t,e));return r}const V=new class{constructor(){this._textures=[],this._sprites=[],this._3dSprites=[],this._rootNode={next:null},this.stageSize={width:8192,height:8192,depth:8192},this.matrixSystem=new B(this.stageSize.width,this.stageSize.height,this.stageSize.depth),this.init()}get gl(){return this._gl}get profiler(){return this._profiler}get textureSystem(){return this._textureSystem}init(){const t=document.getElementById("webgl");t.height=this.stageSize.height,t.width=this.stageSize.width,this._gl=t.getContext("webgl",{preserveDrawingBuffer:!0}),this._canvas=t,this._gl.viewport(0,0,t.width,t.height),this._shaderProgram=p.createProgram(this._gl,s.a,p.replaceShaderTextureString(n.a,c.MAX_TEXTURE_LIMITS(this._gl))),this._textureSystem=new c(this._gl),this._textureSystem.setShader(this._shaderProgram),this._uniformSystem=new U(this._gl),this._uniformSystem.setShader(this._shaderProgram),this._profiler=new l,window.profiler=this._profiler}setStageSize(t){console.log(this._canvas.width,this._canvas.height,this._gl.drawingBufferWidth,this._gl.drawingBufferHeight),this.stageSize=t,this._canvas.width=t.width,this._canvas.height=t.height,this._gl.viewport(0,0,this._gl.drawingBufferWidth,this._gl.drawingBufferHeight),this.matrixSystem.updateStageSize(this.stageSize),this.updateProjectionMatrix(),console.log(this._canvas.width,this._canvas.height,this._gl.drawingBufferWidth,this._gl.drawingBufferHeight),this._gl.drawingBufferWidth===this._canvas.width&&this._gl.drawingBufferHeight===this._canvas.height||this.setStageSize({width:this._gl.drawingBufferWidth,height:this._gl.drawingBufferHeight,depth:this.stageSize.depth})}createTexture(t,e){const i=new _(t,e);return i.setWebglContext(this._gl),this._textures.push(i),i}createSprite(t){const e=new f(t,this);return e.setRenderer(this),this._sprites.push(e),e}clearSprites(){this._sprites=[]}createCubeSprite(t){const e=new m(t,this);return e.setRenderer(this),this._3dSprites.push(e),e}bindSpriteTexture(t,e){t.updateProperties({texture:e})}bindSpriteTextures(t,e){t.updateProperties({textures:e})}batchRender(){const t=c.MAX_TEXTURE_LIMITS(this._gl);let e=[],i=[],r=this._sprites.filter(t=>(t.isPainted=!1,!0));for(;r=r.filter(t=>!t.isPainted),r.length;){for(const s of r)if(e.includes(s.texture))i.push(s),s.isPainted=!0;else{if(!(e.length<t))break;e.push(s.texture),i.push(s),s.isPainted=!0}this.batchRenderImpl(i,e)}for(const t of this._3dSprites)e=[],t.textures.forEach(t=>{e.includes(t)||e.push(t)}),this.batchRenderImpl([t],e)}batchRenderImpl(t,e){this.textureSystem.bindTextures(e);const i=[];t.forEach(t=>{t.webglData.forEach(t=>{t.indexes=t.baseIndexes.map(t=>t+3*i.length),i.push(t)})}),this.renderImpl(i)}renderImpl(t){const e=h.from(t);e.bind(this._gl,this._shaderProgram);this._gl.getExtension("OES_element_index_uint");this._gl.drawElements(this._gl.TRIANGLES,e.indexesLength,this._gl.UNSIGNED_INT,0)}exportStage(){this._canvas.toBlob((function(t){const e=document.createElement("a");document.body.appendChild(e);const i=window.URL.createObjectURL(t);e.href=i,e.download="image",e.click(),window.URL.revokeObjectURL(i),document.body.removeChild(e)}),"image/png")}updateCamera(t){this.matrixSystem.camera=t,this.updateProjectionMatrix()}updatePerspective(t){this.matrixSystem.perspective=t,this.updateProjectionMatrix()}updateProjectionMatrix(){const{stageModelMatrix2D:t,stageModelMatrix3D:e}=this.matrixSystem.updateStageModelMatrix(this.stageSize);this._uniformSystem.bind({uniformName:"modelMatrix2D",value:t}),this._uniformSystem.bind({uniformName:"modelMatrix3D",value:e})}};function W({targetChunkPixels:t,position:e,width:i,height:r,texture:s}){return new Promise(o=>{s.onload(()=>{s.averagePixels||(s.averagePixels=L(s,1,1));const n=t.map((e,i)=>t[i]-s.averagePixels[0][i]),a=V.createSprite({size:{width:i,height:r},position:e,rotation:0});a.updateProperties({colorsDelta:n}),V.bindSpriteTexture(a,s),o()})})}!function({renderer:t,paintImage:e}){const i=document.getElementById("targetImageContainer"),r=document.getElementById("puzzleImagesContainer");function s(t){const e=new Image(100,100);return e.src=t,e}const o=document.createElement("input");o.setAttribute("type","file"),o.setAttribute("accept",".svg,.jpg,.jpeg,.png"),o.setAttribute("multiple",!1);let n=null;const a=[];function h({multiple:t}){return o.setAttribute("multiple",t),new Promise(t=>{o.addEventListener("change",e=>{console.log("触发 change 事件",e.target.files),t(e.target.files)},{once:!0}),o.click()})}function l(){o.value=""}document.getElementById("exportImage").addEventListener("click",()=>t.exportStage());document.getElementById("chooseTargetImage").addEventListener("click",()=>{h({multiple:!1}).then(t=>{n=URL.createObjectURL(t[0]),l(),i.childNodes.length?i.childNodes[0].src=n:i.prepend(s(n))})});document.getElementById("choosePuzzleImage").addEventListener("click",()=>{h({multiple:!0}).then(t=>{for(let e=0;e<t.length;e++){const i=URL.createObjectURL(t[e]);a.push(i),r.prepend(s(i))}l()})});document.getElementById("startRender").addEventListener("click",()=>{n||alert("请选择目标图片!"),a.length||alert("请选择拼图图片!"),e(n,a)})}({renderer:V,paintImage:function(t,e){V.clearSprites();const i=V.createTexture(t),r=e.map(t=>V.createTexture(t));i.onload(()=>{const t=Math.floor(100),e=Math.floor(100*i.height/i.width);!function(t){const e={depth:1e3,height:16384,width:16384};t.height>t.width?(e.width=Math.floor(e.width*t.width/t.height),e.height=e.height):(e.width=e.width,e.height=Math.floor(e.height*t.height/t.width));V.setStageSize({height:e.height,width:e.width,depth:e.depth})}(i);const s=L(i,t,e);console.log(`SUM_COLS:${t},SUM_ROWS:${e}`,s),function({SUM_ROWS:t,SUM_COLS:e,averagePixels:i,texturePuzzles:r}){const s=[];for(let o=0;o<t;o++)for(let n=0;n<e;n++){const a=i[o*e+n],h=r[Math.floor(Math.random()*r.length)],l=V.stageSize.width/e,c=V.stageSize.height/t,u={x:n*l,y:V.stageSize.height-o*c,z:1e3};s.push(W({targetChunkPixels:a,texture:h,width:l,height:c,position:u}))}return Promise.all(s)}({SUM_ROWS:e,SUM_COLS:t,averagePixels:s,texturePuzzles:r}).then(()=>{V.batchRender(),function(t){const e=document.getElementById("webgl"),i=e.getBoundingClientRect();if(window.innerHeight>window.innerWidth){const r=t.height/t.width*i.width;e.style.height=r+"px"}else{const r=t.width/t.height*i.height;e.style.width=r+"px"}}(V.stageSize)})})}})}],[[2,1]]]);